<%- include('partials/header', { pageTitle: pageTitle, currentUser: currentUser }) %>

<h1 class="h2 mb-4 text-danger">Create Flight Plan</h1>

<% if (typeof pageError !== 'undefined' && pageError) { %>
    <div class="alert alert-danger" role="alert">
        Error loading page data: <%= pageError %>
    </div>
<% } %>

<p class="text-muted mb-4">Add available flight legs using the button below. Arrange and validate your plan, then save it.</p>

<div class="card shadow-sm border-light mb-4">
    <div class="card-body">
        <form id="create-plan-form" class="row g-3 align-items-end needs-validation" novalidate>
            <div class="col-md-8">
                <label for="planName" class="form-label fw-bold">Plan Name:</label>
                <input type="text" class="form-control" id="planName" name="planName" placeholder="e.g., My Awesome Trip" required minlength="3">
                <div class="invalid-feedback">Please enter a name for your plan (minimum 3 characters).</div>
            </div>
            <div class="col-md-4 d-grid">
                 <button type="submit" class="btn btn-success fw-bold" id="save-plan-button">
                     <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                     Save Flight Plan
                 </button>
            </div>
        </form>
         <div id="form-message" class="mt-3"></div> </div>
</div>

<div class="card shadow-sm border-light">
    <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
       <span>Selected Flight Legs</span>
       <button type="button" class="btn btn-sm btn-danger" id="add-leg-button" data-bs-toggle="modal" data-bs-target="#addLegModal">
           + Add Flight Leg
       </button>
    </div>
    <div class="card-body">
        <ul id="selected-legs-list" class="list-group list-group-flush">
            <li id="no-legs-message" class="list-group-item text-muted fst-italic">No flights added to this plan yet. Click "+ Add Flight Leg" to start.</li>
        </ul>
         <div id="plan-validation-message" class="text-danger small mt-3 fw-bold"></div>
    </div>
</div>

<div class="modal fade" id="addLegModal" tabindex="-1" aria-labelledby="addLegModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="addLegModalLabel">Select Available Flight Leg</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
              <div id="modal-error-message" class="alert alert-warning d-none"></div>
              <div id="modal-legs-list" class="list-group list-group-flush">
                  </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
</div>


<script id="available-legs-data" type="application/json">
    <%- availableLegsJson %>
</script>
<%- include('partials/footer', { script: 'plan-builder-interactive' }) %>